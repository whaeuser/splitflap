<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentic Split-Flap Display</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #000000;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .flip-board {
            background: transparent;
            padding: 0;
            border: none;
            box-shadow: none;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .display-line {
            display: flex;
            justify-content: center;
            margin-bottom: 1vh;
            gap: 0.3vw;
        }

        .flip-char {
            width: 5.5vw;
            height: 8.25vw;
            position: relative;
            background: #1a1a1a;
            border: 0.15vw solid #333;
            border-radius: 0.6vw;
            overflow: hidden;
            margin: 0.15vw;
            perspective: 45vw;
        }

        .flip-half {
            position: absolute;
            width: 100%;
            height: 50%;
            background: linear-gradient(to bottom, #2a2a2a 0%, #1a1a1a 100%);
            overflow: hidden;
            transform-style: preserve-3d;
        }

        .flip-char-content {
            position: absolute;
            width: 100%;
            height: 8.25vw;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 7vw;
            font-weight: bold;
            color: #fff;
            text-align: center;
            line-height: 8.25vw;
            overflow: hidden;
        }

        .flip-top {
            top: 0;
            transform-origin: bottom;
        }

        .flip-top .flip-char-content {
            top: 0;
            clip-path: inset(0 0 50% 0); /* Show only top half */
        }

        .flip-bottom {
            bottom: 0;
            background: linear-gradient(to bottom, #1a1a1a 0%, #0a0a0a 100%);
            transform-origin: top;
        }

        .flip-bottom .flip-char-content {
            top: -4.125vw; /* Offset to show bottom half */
            clip-path: inset(50% 0 0 0); /* Show only bottom half */
        }

        .flip-top.flipping {
            animation: flipTop 0.3s ease-in forwards;
        }

        .flip-bottom.reveal {
            animation: flipBottom 0.3s ease-out 0.3s forwards;
            transform: rotateX(90deg);
        }

        @keyframes flipTop {
            0% { transform: rotateX(0deg); }
            100% { transform: rotateX(-90deg); }
        }

        @keyframes flipBottom {
            0% { transform: rotateX(90deg); }
            100% { transform: rotateX(0deg); }
        }

        /* Middle line separator */
        .flip-char::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0.3vw;
            right: 0.3vw;
            height: 0.15vw;
            background: #333;
            z-index: 10;
            transform: translateY(-0.075vw);
        }

        /* Glossy effect */
        .flip-char::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                to right,
                rgba(255,255,255,0.1) 0%,
                transparent 20%,
                transparent 80%,
                rgba(0,0,0,0.2) 100%
            );
            pointer-events: none;
            z-index: 5;
        }

        .controls {
            margin-top: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        input {
            padding: 10px 15px;
            border: 2px solid #444;
            border-radius: 5px;
            background: #2a2a3e;
            color: white;
            font-size: 16px;
            min-width: 200px;
        }

        input:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        button {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #000;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            background: linear-gradient(135deg, #ffed4e, #ffd700);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }

        .preset-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .preset-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 8px 16px;
            font-size: 14px;
        }

        .preset-btn:hover {
            background: linear-gradient(135deg, #45a049, #4CAF50);
        }

        .sound-toggle {
            background: linear-gradient(135deg, #9C27B0, #7B1FA2);
            color: white;
            padding: 8px 16px;
            font-size: 14px;
        }

        .sound-toggle:hover {
            background: linear-gradient(135deg, #7B1FA2, #9C27B0);
        }

        .sound-toggle.muted {
            background: linear-gradient(135deg, #666, #555);
        }

        @media (max-width: 768px) {
            .flip-char {
                width: 8vw;
                height: 12vw;
            }

            .flip-char-content {
                height: 12vw;
                font-size: 9vw;
                line-height: 12vw;
            }

            .flip-bottom .flip-char-content {
                top: -6vw;
            }

            /* Middle line separator for mobile */
            .flip-char::before {
                left: 0.4vw;
                right: 0.4vw;
                height: 0.2vw;
                transform: translateY(-0.1vw);
            }
        }

        .clicking {
            position: relative;
        }

        .clicking::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: rgba(255, 215, 0, 0.2);
            border-radius: 6px;
            animation: clickHighlight 0.6s ease-out;
            z-index: -1;
        }

        @keyframes clickHighlight {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(1.1); }
        }
    </style>
</head>
<body>
    <div class="flip-board">
        <div class="display-line" id="line1"></div>
        <div class="display-line" id="line2"></div>
        <div class="display-line" id="line3"></div>
        <div class="display-line" id="line4"></div>
        <div class="display-line" id="line5"></div>
        <div class="display-line" id="line6"></div>
    </div>

    <!-- Hidden controls for API access -->
    <div class="controls" style="display: none;">
        <input type="text" id="textInput" placeholder="Text eingeben..." maxlength="16">
        <button class="sound-toggle" id="soundToggle" onclick="toggleSound()">ðŸ”Š Sound</button>
    </div>

    <script>
        const CHARACTERS = ' ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789:-./';
        let currentTexts = ['', '', '', '', '', ''];
        let isAnimating = false;
        let soundEnabled = true;
        let audioContext = null;

        // Initialize audio context
        function initAudio() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('Audio not supported');
                    soundEnabled = false;
                }
            }
        }

        // Generate realistic mechanical click sound
        function playClickSound() {
            if (!soundEnabled) {
                console.log('Sound disabled');
                return;
            }

            if (!audioContext) {
                console.log('No audio context available');
                return;
            }

            if (audioContext.state === 'suspended') {
                console.log('Audio context suspended, trying to resume...');
                audioContext.resume().then(() => {
                    console.log('Audio context resumed, playing sound');
                    playActualSound();
                }).catch(e => {
                    console.log('Failed to resume audio context:', e);
                });
                return;
            }

            playActualSound();
        }

        function playActualSound() {
            try {
                const now = audioContext.currentTime;

                // Create realistic mechanical click with multiple components

                // 1. Initial impact (sharp click)
                const impact = audioContext.createOscillator();
                const impactGain = audioContext.createGain();
                const impactFilter = audioContext.createBiquadFilter();

                impact.connect(impactFilter);
                impactFilter.connect(impactGain);
                impactGain.connect(audioContext.destination);

                impact.type = 'square';
                impact.frequency.setValueAtTime(800, now);
                impact.frequency.exponentialRampToValueAtTime(120, now + 0.015);

                impactFilter.type = 'highpass';
                impactFilter.frequency.setValueAtTime(400, now);

                impactGain.gain.setValueAtTime(0, now);
                impactGain.gain.linearRampToValueAtTime(0.12, now + 0.002);
                impactGain.gain.exponentialRampToValueAtTime(0.001, now + 0.025);

                impact.start(now);
                impact.stop(now + 0.025);

                // 2. Mechanical resonance (metallic ring)
                const resonance = audioContext.createOscillator();
                const resonanceGain = audioContext.createGain();
                const resonanceFilter = audioContext.createBiquadFilter();

                resonance.connect(resonanceFilter);
                resonanceFilter.connect(resonanceGain);
                resonanceGain.connect(audioContext.destination);

                resonance.type = 'triangle';
                resonance.frequency.setValueAtTime(1800, now + 0.005);
                resonance.frequency.exponentialRampToValueAtTime(900, now + 0.04);

                resonanceFilter.type = 'bandpass';
                resonanceFilter.frequency.setValueAtTime(1500, now);
                resonanceFilter.Q.setValueAtTime(8, now);

                resonanceGain.gain.setValueAtTime(0, now + 0.005);
                resonanceGain.gain.linearRampToValueAtTime(0.06, now + 0.01);
                resonanceGain.gain.exponentialRampToValueAtTime(0.001, now + 0.06);

                resonance.start(now + 0.005);
                resonance.stop(now + 0.06);

                // 3. Damping noise (plastic/metal contact)
                const noise = audioContext.createOscillator();
                const noiseGain = audioContext.createGain();
                const noiseFilter = audioContext.createBiquadFilter();

                noise.connect(noiseFilter);
                noiseFilter.connect(noiseGain);
                noiseGain.connect(audioContext.destination);

                noise.type = 'sawtooth';
                noise.frequency.setValueAtTime(350, now + 0.01);
                noise.frequency.exponentialRampToValueAtTime(80, now + 0.05);

                noiseFilter.type = 'lowpass';
                noiseFilter.frequency.setValueAtTime(600, now);
                noiseFilter.Q.setValueAtTime(1, now);

                noiseGain.gain.setValueAtTime(0, now + 0.01);
                noiseGain.gain.linearRampToValueAtTime(0.04, now + 0.015);
                noiseGain.gain.exponentialRampToValueAtTime(0.001, now + 0.08);

                noise.start(now + 0.01);
                noise.stop(now + 0.08);

                // 4. Subtle motor/mechanism sound
                const motor = audioContext.createOscillator();
                const motorGain = audioContext.createGain();
                const motorFilter = audioContext.createBiquadFilter();

                motor.connect(motorFilter);
                motorFilter.connect(motorGain);
                motorGain.connect(audioContext.destination);

                motor.type = 'sawtooth';
                motor.frequency.setValueAtTime(60, now);
                motor.frequency.linearRampToValueAtTime(40, now + 0.1);

                motorFilter.type = 'highpass';
                motorFilter.frequency.setValueAtTime(30, now);

                motorGain.gain.setValueAtTime(0, now);
                motorGain.gain.linearRampToValueAtTime(0.02, now + 0.02);
                motorGain.gain.exponentialRampToValueAtTime(0.001, now + 0.12);

                motor.start(now);
                motor.stop(now + 0.12);

                console.log('Authentic mechanical sound played');

            } catch (e) {
                console.log('Sound generation failed:', e);
            }
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            const button = document.getElementById('soundToggle');
            
            if (soundEnabled) {
                initAudio();
                button.textContent = 'ðŸ”Š Sound';
                button.classList.remove('muted');
            } else {
                button.textContent = 'ðŸ”‡ Stumm';
                button.classList.add('muted');
            }
        }

        function createFlipChar(initialChar = ' ') {
            const char = document.createElement('div');
            char.className = 'flip-char';
            
            const topHalf = document.createElement('div');
            topHalf.className = 'flip-half flip-top';
            
            const topContent = document.createElement('div');
            topContent.className = 'flip-char-content';
            topContent.textContent = initialChar;
            topHalf.appendChild(topContent);
            
            const bottomHalf = document.createElement('div');
            bottomHalf.className = 'flip-half flip-bottom';
            
            const bottomContent = document.createElement('div');
            bottomContent.className = 'flip-char-content';
            bottomContent.textContent = initialChar;
            bottomHalf.appendChild(bottomContent);
            
            char.appendChild(topHalf);
            char.appendChild(bottomHalf);
            
            return char;
        }

        function initializeDisplay() {
            for (let lineNum = 1; lineNum <= 6; lineNum++) {
                const line = document.getElementById(`line${lineNum}`);
                line.innerHTML = '';

                for (let i = 0; i < 16; i++) {
                    line.appendChild(createFlipChar(' '));
                }
            }
            currentTexts = ['', '', '', '', '', ''];
        }

        function flipCharacter(charElement, newChar, delay = 0) {
            setTimeout(() => {
                const currentChar = charElement.querySelector('.flip-top .flip-char-content').textContent;

                // Skip if already showing the correct character
                if (currentChar === newChar) return;

                // Create mechanical sequence with intermediate characters
                const sequence = generateFlipSequence(currentChar, newChar);

                // Add visual effect for entire sequence
                charElement.classList.add('clicking');

                // Execute flip sequence
                executeFlipSequence(charElement, sequence, () => {
                    charElement.classList.remove('clicking');
                });

            }, delay);
        }

        function generateFlipSequence(fromChar, toChar) {
            const fromIndex = CHARACTERS.indexOf(fromChar);
            const toIndex = CHARACTERS.indexOf(toChar);

            // If same character, no animation needed
            if (fromIndex === toIndex) return [];

            const sequence = [];
            let currentIndex = fromIndex;

            // Determine direction (forward or backward through alphabet)
            const forward = (toIndex - fromIndex + CHARACTERS.length) % CHARACTERS.length;
            const backward = (fromIndex - toIndex + CHARACTERS.length) % CHARACTERS.length;
            const useForward = forward <= backward;

            // Generate intermediate steps (3-6 flips for realism)
            const steps = Math.min(Math.max(3, Math.abs(toIndex - fromIndex)), 6);

            for (let i = 1; i <= steps; i++) {
                if (useForward) {
                    currentIndex = (fromIndex + Math.floor((forward * i) / steps)) % CHARACTERS.length;
                } else {
                    currentIndex = (fromIndex - Math.floor((backward * i) / steps) + CHARACTERS.length) % CHARACTERS.length;
                }

                sequence.push({
                    char: CHARACTERS[currentIndex],
                    duration: i === steps ? 300 : 150, // Last flip is slower
                    isLast: i === steps
                });
            }

            // Ensure final character is correct
            if (sequence[sequence.length - 1].char !== toChar) {
                sequence[sequence.length - 1].char = toChar;
            }

            return sequence;
        }

        function executeFlipSequence(charElement, sequence, onComplete) {
            if (sequence.length === 0) {
                onComplete();
                return;
            }

            let currentStep = 0;

            function doNextFlip() {
                if (currentStep >= sequence.length) {
                    onComplete();
                    return;
                }

                const step = sequence[currentStep];
                const topHalf = charElement.querySelector('.flip-top');
                const bottomHalf = charElement.querySelector('.flip-bottom');
                const topContent = topHalf.querySelector('.flip-char-content');
                const bottomContent = bottomHalf.querySelector('.flip-char-content');

                // Play click sound for each flip
                playClickSound();

                // Update the bottom content to new character (will be revealed)
                bottomContent.textContent = step.char;

                // Start flip animation with appropriate timing
                topHalf.style.animation = `flipTop ${step.duration}ms ease-in forwards`;
                bottomHalf.style.animation = `flipBottom ${step.duration}ms ease-out ${step.duration}ms forwards`;
                bottomHalf.style.transform = 'rotateX(90deg)';

                // After this flip completes, update top half and continue
                setTimeout(() => {
                    topContent.textContent = step.char;

                    // Reset animations
                    topHalf.style.animation = '';
                    bottomHalf.style.animation = '';
                    bottomHalf.style.transform = '';

                    currentStep++;

                    // Small pause between flips for realism
                    setTimeout(doNextFlip, step.isLast ? 0 : 50);

                }, step.duration * 2);
            }

            doNextFlip();
        }

        function updateLine(lineIndex, newText, startDelay = 0) {
            const line = document.getElementById(`line${lineIndex + 1}`);
            const chars = line.querySelectorAll('.flip-char');
            
            newText = newText.toUpperCase().padEnd(16, ' ').substring(0, 16);
            const oldText = currentTexts[lineIndex].padEnd(16, ' ').substring(0, 16);
            
            // Only flip characters that actually changed
            chars.forEach((char, index) => {
                if (newText[index] !== oldText[index]) {
                    flipCharacter(char, newText[index], startDelay + index * 80);
                }
            });
            
            currentTexts[lineIndex] = newText.trimEnd();
        }

        function updateDisplay() {
            if (isAnimating) return;
            
            const input = document.getElementById('textInput');
            const text = input.value.trim();
            
            if (text) {
                isAnimating = true;
                updateLine(1, text);
                
                setTimeout(() => {
                    isAnimating = false;
                }, 2500);
            }
        }

        function clearDisplay() {
            if (isAnimating) return;

            isAnimating = true;
            updateLine(0, '');
            updateLine(1, '');
            updateLine(2, '');
            updateLine(3, '');
            updateLine(4, '');
            updateLine(5, '');

            setTimeout(() => {
                isAnimating = false;
            }, 2500);
        }

        function setPreset(text) {
            document.getElementById('textInput').value = text;
            updateDisplay();
        }

        function startDemo() {
            if (isAnimating) return;

            isAnimating = true;
            const demoSequence = [
                ['FLUGHAFEN', 'MUENCHEN', 'TERMINAL 2', 'ABFLUG', 'GATE A15', '12:30'],
                ['LH 441', 'NACH FRANKFURT', 'BOARDING NOW', 'GATE B7', 'PÃœNKTLICH', ''],
                ['AIR FRANCE', 'NACH PARIS', 'VERSPAETUNG', '+25 MINUTEN', 'GATE C3', '14:45'],
                ['LUFTHANSA', 'NACH BERLIN', 'LETZTER AUFRUF', 'GATE A2', 'SOFORT', ''],
                ['GUTEN FLUG', 'AUF WIEDERSEHEN', 'DANKE', 'SCHÃ–NEN TAG', '', '']
            ];

            let step = 0;

            function nextDemoStep() {
                if (step < demoSequence.length) {
                    const [line1, line2, line3, line4, line5, line6] = demoSequence[step];

                    updateLine(0, line1, 0);
                    updateLine(1, line2, 200);
                    updateLine(2, line3, 400);
                    updateLine(3, line4, 600);
                    updateLine(4, line5, 800);
                    updateLine(5, line6, 1000);

                    step++;
                    setTimeout(nextDemoStep, 5000);
                } else {
                    setTimeout(() => {
                        isAnimating = false;
                    }, 2000);
                }
            }

            nextDemoStep();
        }

        // Event Listeners
        document.getElementById('textInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                updateDisplay();
            }
        });

        // Enable audio immediately or on first interaction
        function ensureAudioContext() {
            if (soundEnabled && !audioContext) {
                initAudio();
            }
        }

        // Try to enable audio immediately
        function tryEnableAudioImmediately() {
            if (!soundEnabled) return;

            // iOS Safari requires user interaction, set up listeners immediately
            if (navigator.userAgent.includes('Safari') && navigator.userAgent.includes('Mobile')) {
                console.log('iOS Safari detected, setting up touch listeners');
                setupUserInteractionListeners();
                return;
            }

            try {
                // Try to create audio context immediately for desktop
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('Audio context created immediately');
                }

                // Test if audio context is allowed to start
                if (audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        console.log('Audio context resumed successfully');
                    }).catch(() => {
                        console.log('Audio context resume failed, waiting for user interaction');
                        setupUserInteractionListeners();
                    });
                }
            } catch (e) {
                console.log('Immediate audio failed:', e.message, 'waiting for user interaction');
                setupUserInteractionListeners();
            }
        }

        function setupUserInteractionListeners() {
            function enableAudioOnInteraction(event) {
                console.log('User interaction detected:', event.type);

                if (!audioContext) {
                    try {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        console.log('Audio context created on user interaction');
                    } catch (e) {
                        console.log('Failed to create audio context:', e);
                        return;
                    }
                }

                if (audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        console.log('Audio context resumed on user interaction');
                        // Test sound to confirm it works
                        setTimeout(() => {
                            if (soundEnabled) {
                                console.log('Playing test sound');
                                playActualSound();
                            }
                        }, 100);
                    }).catch((e) => {
                        console.log('Failed to resume audio context:', e);
                    });
                }

                // Remove listeners after successful activation
                document.removeEventListener('click', enableAudioOnInteraction);
                document.removeEventListener('keydown', enableAudioOnInteraction);
                document.removeEventListener('touchstart', enableAudioOnInteraction);
                document.removeEventListener('touchend', enableAudioOnInteraction);

                console.log('Audio interaction listeners removed');
            }

            // Add comprehensive interaction listeners for iOS
            document.addEventListener('click', enableAudioOnInteraction, { passive: true });
            document.addEventListener('keydown', enableAudioOnInteraction, { passive: true });
            document.addEventListener('touchstart', enableAudioOnInteraction, { passive: true });
            document.addEventListener('touchend', enableAudioOnInteraction, { passive: true });

            console.log('Audio interaction listeners added');
        }

        // API Functions
        window.splitflapAPI = {
            // Set text on a specific line (0-5)
            setLine: function(lineIndex, text) {
                if (lineIndex >= 0 && lineIndex <= 5 && !isAnimating) {
                    updateLine(lineIndex, text);
                }
            },

            // Set all lines at once
            setDisplay: function(line1 = '', line2 = '', line3 = '', line4 = '', line5 = '', line6 = '') {
                if (!isAnimating) {
                    ensureAudioContext(); // Ensure audio works for API calls
                    isAnimating = true;
                    updateLine(0, line1, 0);
                    updateLine(1, line2, 200);
                    updateLine(2, line3, 400);
                    updateLine(3, line4, 600);
                    updateLine(4, line5, 800);
                    updateLine(5, line6, 1000);
                    setTimeout(() => { isAnimating = false; }, 3500);
                }
            },

            // Clear all lines
            clear: function() {
                ensureAudioContext(); // Ensure audio works for API calls
                clearDisplay();
            },

            // Start demo sequence
            demo: function() {
                ensureAudioContext(); // Ensure audio works for API calls
                startDemo();
            },

            // Toggle sound
            toggleSound: function() {
                toggleSound();
            },

            // Get current display state
            getCurrentDisplay: function() {
                return [...currentTexts];
            },

            // Check if animation is running
            isAnimating: function() {
                return isAnimating;
            }
        };

        // HTTP API via URL parameters
        function handleURLParams() {
            const params = new URLSearchParams(window.location.search);

            // Check sound parameter
            if (params.has('sound')) {
                const soundParam = params.get('sound').toLowerCase();
                soundEnabled = soundParam !== 'false' && soundParam !== '0' && soundParam !== 'off';

                // Update sound toggle button if it exists
                const soundToggle = document.getElementById('soundToggle');
                if (soundToggle) {
                    if (soundEnabled) {
                        soundToggle.textContent = 'ðŸ”Š Sound';
                        soundToggle.classList.remove('muted');
                    } else {
                        soundToggle.textContent = 'ðŸ”‡ Stumm';
                        soundToggle.classList.add('muted');
                    }
                }
            }

            if (params.has('line1') || params.has('line2') || params.has('line3') ||
                params.has('line4') || params.has('line5') || params.has('line6')) {
                const line1 = params.get('line1') || '';
                const line2 = params.get('line2') || '';
                const line3 = params.get('line3') || '';
                const line4 = params.get('line4') || '';
                const line5 = params.get('line5') || '';
                const line6 = params.get('line6') || '';

                setTimeout(() => {
                    window.splitflapAPI.setDisplay(line1, line2, line3, line4, line5, line6);
                }, 1000);
            } else if (params.has('demo')) {
                setTimeout(() => {
                    window.splitflapAPI.demo();
                }, 1000);
            } else if (params.has('clear')) {
                setTimeout(() => {
                    window.splitflapAPI.clear();
                }, 1000);
            }
        }

        // HTTP API server communication via polling
        function connectToServer() {
            function pollCommands() {
                fetch('/api/commands')
                    .then(response => response.json())
                    .then(data => {
                        if (data.action === 'setDisplay') {
                            console.log('Received setDisplay command:', data);
                            window.splitflapAPI.setDisplay(
                                data.line1, data.line2, data.line3,
                                data.line4, data.line5, data.line6
                            );
                        } else if (data.action === 'clear') {
                            console.log('Received clear command');
                            window.splitflapAPI.clear();
                        } else if (data.action === 'demo') {
                            console.log('Received demo command');
                            window.splitflapAPI.demo();
                        }
                    })
                    .catch(error => {
                        console.error('Error polling commands:', error);
                    });

                // Poll every 500ms
                setTimeout(pollCommands, 500);
            }

            // Start polling
            pollCommands();
        }

        // PostMessage API for iframe communication
        window.addEventListener('message', function(event) {
            const { action, data } = event.data;

            switch (action) {
                case 'setDisplay':
                    window.splitflapAPI.setDisplay(
                        data.line1, data.line2, data.line3,
                        data.line4, data.line5, data.line6
                    );
                    break;
                case 'setLine':
                    window.splitflapAPI.setLine(data.lineIndex, data.text);
                    break;
                case 'clear':
                    window.splitflapAPI.clear();
                    break;
                case 'demo':
                    window.splitflapAPI.demo();
                    break;
                case 'toggleSound':
                    window.splitflapAPI.toggleSound();
                    break;
                case 'getState':
                    event.source.postMessage({
                        type: 'splitflapState',
                        display: window.splitflapAPI.getCurrentDisplay(),
                        isAnimating: window.splitflapAPI.isAnimating()
                    }, event.origin);
                    break;
            }
        });

        // Add iOS-specific audio unlock button
        function createAudioUnlockButton() {
            if (navigator.userAgent.includes('Safari') && navigator.userAgent.includes('Mobile')) {
                const button = document.createElement('div');
                button.id = 'ios-audio-unlock';
                button.innerHTML = 'ðŸ”Š Touch to Enable Sound';
                button.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #ffd700, #ffed4e);
                    color: #000;
                    padding: 10px 20px;
                    border-radius: 25px;
                    font-weight: bold;
                    cursor: pointer;
                    z-index: 1000;
                    font-size: 16px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                `;

                button.addEventListener('touchstart', function() {
                    ensureAudioContext();
                    button.style.display = 'none';
                });

                document.body.appendChild(button);

                // Hide button after 10 seconds
                setTimeout(() => {
                    if (button.parentNode) {
                        button.style.display = 'none';
                    }
                }, 10000);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeDisplay();
            handleURLParams();

            // Connect to server for API commands
            connectToServer();

            // Try to enable audio immediately
            tryEnableAudioImmediately();

            // Create iOS audio unlock button if needed
            createAudioUnlockButton();

            // Default welcome sequence if no URL params
            if (!window.location.search) {
                setTimeout(() => {
                    updateLine(1, 'SPLIT FLAP', 0);
                    setTimeout(() => {
                        updateLine(1, 'BEREIT', 0);
                    }, 2000);
                }, 800);
            }
        });
    </script>
</body>
</html>
